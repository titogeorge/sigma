name: security
applications: ""
definitions:
- name: lateral_movement_indicator_condrv
  description: This event was observed on the target host during lateral movement.
    The process name within the event contains the process spawned post compromise.
    Account Name within the event contains the compromised user account name. This
    event should to be correlated with 4624 and 4688 for further intrusion context.
  condition: ([EventID] == 4674) && ([ObjectServer] == ['Security']) && ([ObjectType]
    == ['File']) && ([ObjectName] == ['\Device\ConDrv'])
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,execution,t1021,t1059
  exttype: SIEM
- name: windows_pcap_drivers
  description: Detects Windows Pcap driver installation based on a list of associated
    .sys files.
  condition: ([EventID] == 4697) && (([ServiceFileName] =~ ['.*pcap.*']) || ([ServiceFileName]
    =~ ['.*npcap.*']) || ([ServiceFileName] =~ ['.*npf.*']) || ([ServiceFileName]
    =~ ['.*nm3.*']) || ([ServiceFileName] =~ ['.*ndiscap.*']) || ([ServiceFileName]
    =~ ['.*nmnt.*']) || ([ServiceFileName] =~ ['.*windivert.*']) || ([ServiceFileName]
    =~ ['.*USBPcap.*']) || ([ServiceFileName] =~ ['.*pktmon.*']))
  level: medium
  ruletype: EVALUATE
  tags: attack,discovery,credential_access,t1040
  exttype: SIEM
- name: windows_defender_exclusion_set
  description: Detects scenarios where an windows defender exclusion was added in
    registry where an entity would want to bypass antivirus scanning from windows
    defender
  condition: (([EventID] == 4657) || ([EventID] == 4656) || ([EventID] == 4660) ||
    ([EventID] == 4663)) && ([ObjectName] =~ ['.*.*Microsoft.*Windows.*Defender.*Exclusions.*.*.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1089,t1562,001
  exttype: SIEM
- name: wmi_persistence
  description: Detects suspicious WMI event filter and command line event consumer
    based on WMI and Security Logs.
  condition: ([EventID] == 4662) && ([ObjectType] == ['WMI Namespace']) && ([ObjectName]
    =~ ['.*subscription.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,persistence,privilege_escalation,t1084,t1546,003
  exttype: SIEM
- name: smb_create_remote_file_admin_share
  description: Look for non-system accounts SMB accessing a file with write (0x2)
    access mask via administrative share (i.e C$).
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*C.*']) && ([AccessMask] ==
    ['0x2']) && ([SubjectUserName] !~ ['.*.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1021,002
  exttype: SIEM
- name: active_directory_user_backdoors
  description: Detects scenarios where one can control another users or computers
    account without having to use their credentials.
  condition: ([EventID] == 4738) && ([AllowedToDelegateTo] == ['-']) || ([EventID]
    == 5136) && ([AttributeLDAPDisplayName] == ['msDS-AllowedToDelegateTo']) || ([EventID]
    == 5136) && ([ObjectClass] == ['user']) && ([AttributeLDAPDisplayName] == ['servicePrincipalName'])
    || ([EventID] == 5136) && ([AttributeLDAPDisplayName] == ['msDS-AllowedToActOnBehalfOfOtherIdentity'])
  level: high
  ruletype: EVALUATE
  tags: attack,t1098,persistence
  exttype: SIEM
- name: disabling_windows_event_auditing
  description: 'Detects scenarios where system auditing (ie: windows event log auditing)
    is disabled. This may be used in a scenario where an entity would want to bypass
    local logging to evade detection when windows event logging is enabled and reviewed.
    Also, it is recommended to turn off "Local Group Policy Object Processing" via
    GPO, which will make sure that Active Directory GPOs take precedence over local/edited
    computer policies via something such as "gpedit.msc". Please note, that disabling
    "Local Group Policy Object Processing" may cause an issue in scenarios of one
    off specific GPO modifications -- however it is recommended to perform these modifications
    in Active Directory anyways.'
  condition: ([EventID] == 4719) && (([AuditPolicyChanges] =~ ['.*.*.*8448.*']) ||
    ([AuditPolicyChanges] =~ ['.*.*.*8450.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1054,t1562,002
  exttype: SIEM
- name: possible_zerologon__cve_2020_1472__exploitation
  description: Detects Netlogon Elevation of Privilege Vulnerability aka Zerologon
    (CVE-2020-1472)
  condition: ([EventID] == 4742) && ([SubjectUserName] == ['ANONYMOUS LOGON']) &&
    ([TargetUserName] == ['%DC-MACHINE-NAME%']) && ([PasswordLastSet] == ['-'])
  level: high
  ruletype: EVALUATE
  tags: attack,t1068,privilege_escalation
  exttype: SIEM
- name: rdp_over_reverse_ssh_tunnel_wfp
  description: Detects svchost hosting RDP termsvcs communicating with the loopback
    address
  condition: ([EventID] == 5156) && ([SourcePort] == 3389) && (([DestAddress] =~ ['127..*'])
    || ([DestAddress] =~ ['.*.*1'])) || ([DestPort] == 3389) && (([SourceAddress]
    =~ ['127..*']) || ([SourceAddress] =~ ['.*.*1']))
  level: high
  ruletype: EVALUATE
  tags: attack,defense_evasion,command_and_control,lateral_movement,t1076,t1090,001,002,t1021,car,2013-07-002
  exttype: SIEM
- name: kerberos_manipulation
  description: This method triggers on rare Kerberos Failure Codes caused by manipulations
    of Kerberos messages
  condition: (([EventID] == 675) || ([EventID] == 4768) || ([EventID] == 4769) ||
    ([EventID] == 4771)) && (([FailureCode] =~ ['0x9']) || ([FailureCode] =~ ['0xA'])
    || ([FailureCode] =~ ['0xB']) || ([FailureCode] =~ ['0xF']) || ([FailureCode]
    =~ ['0x10']) || ([FailureCode] =~ ['0x11']) || ([FailureCode] =~ ['0x13']) ||
    ([FailureCode] =~ ['0x14']) || ([FailureCode] =~ ['0x1A']) || ([FailureCode] =~
    ['0x1F']) || ([FailureCode] =~ ['0x21']) || ([FailureCode] =~ ['0x22']) || ([FailureCode]
    =~ ['0x23']) || ([FailureCode] =~ ['0x24']) || ([FailureCode] =~ ['0x26']) ||
    ([FailureCode] =~ ['0x27']) || ([FailureCode] =~ ['0x28']) || ([FailureCode] =~
    ['0x29']) || ([FailureCode] =~ ['0x2C']) || ([FailureCode] =~ ['0x2D']) || ([FailureCode]
    =~ ['0x2E']) || ([FailureCode] =~ ['0x2F']) || ([FailureCode] =~ ['0x31']) ||
    ([FailureCode] =~ ['0x32']) || ([FailureCode] =~ ['0x3E']) || ([FailureCode] =~
    ['0x3F']) || ([FailureCode] =~ ['0x40']) || ([FailureCode] =~ ['0x41']) || ([FailureCode]
    =~ ['0x43']) || ([FailureCode] =~ ['0x44']))
  level: high
  ruletype: EVALUATE
  tags: attack,credential_access,t1212
  exttype: SIEM
- name: arbitrary_shell_command_execution_via_settingcontent_ms
  description: The .SettingContent-ms file type was introduced in Windows 10 and allows
    a user to create "shortcuts" to various Windows 10 setting pages. These files
    are simply XML and contain paths to various Windows 10 settings binaries.
  condition: ([CommandLine] =~ ['.*.SettingContent.*ms.*']) && ([FilePath] !~ ['.*immersivecontrolpanel.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,t1204,t1193,t1566,001,execution,initial_access
  exttype: SIEM
- name: meterpreter_or_cobalt_strike_getsystem_service_installation
  description: Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting
    a specific service installation
  condition: ([ServiceFileName] =~ ['.*cmd.*']) && ([ServiceFileName] =~ ['.*.*c.*'])
    && ([ServiceFileName] =~ ['.*echo.*']) && ([ServiceFileName] =~ ['.*.*pipe.*.*.*'])
    || ([ServiceFileName] =~ ['.*.*COMSPEC.*.*']) && ([ServiceFileName] =~ ['.*.*c.*'])
    && ([ServiceFileName] =~ ['.*echo.*']) && ([ServiceFileName] =~ ['.*.*pipe.*.*.*'])
    || ([ServiceFileName] =~ ['.*cmd.exe.*']) && ([ServiceFileName] =~ ['.*.*c.*'])
    && ([ServiceFileName] =~ ['.*echo.*']) && ([ServiceFileName] =~ ['.*.*pipe.*.*.*'])
    || ([ServiceFileName] =~ ['.*rundll32.*']) && ([ServiceFileName] =~ ['.*.dll.*a.*'])
    && ([ServiceFileName] =~ ['.*.*p.*.*'])
  level: critical
  ruletype: EVALUATE
  tags: attack,privilege_escalation,t1134,001,002
  exttype: SIEM
- name: suspicious_windows_anonymous_logon_local_account_created
  description: Detects the creation of suspicious accounts similar to ANONYMOUS LOGON,
    such as using additional spaces. Created as an covering detection for exclusion
    of Logon Type 3 from ANONYMOUS LOGON accounts.
  condition: ([EventID] == 4720) && ([SamAccountName] =~ ['.*ANONYMOUS.*']) && ([SamAccountName]
    =~ ['.*LOGON.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,persistence,t1136,001,002
  exttype: SIEM
- name: hidden_local_user_creation
  description: Detects the creation of a local hidden user account which should not
    happen for event ID 4720.
  condition: ([EventID] == 4720) && ([TargetUserName] =~ ['.*.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,persistence,t1136,001
  exttype: SIEM
- name: ad_privileged_users_or_groups_reconnaissance
  description: Detect priv users or groups recon based on 4661 eventid and known privileged
    users or groups SIDs
  condition: ([EventID] == 4661) && (([ObjectType] =~ ['SAM.*USER']) || ([ObjectType]
    =~ ['SAM.*GROUP'])) && (([ObjectName] =~ ['.*.*512']) || ([ObjectName] =~ ['.*.*502'])
    || ([ObjectName] =~ ['.*.*500']) || ([ObjectName] =~ ['.*.*505']) || ([ObjectName]
    =~ ['.*.*519']) || ([ObjectName] =~ ['.*.*520']) || ([ObjectName] =~ ['.*.*544'])
    || ([ObjectName] =~ ['.*.*551']) || ([ObjectName] =~ ['.*.*555'])) || ([ObjectName]
    =~ ['.*admin.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,discovery,t1087,002
  exttype: SIEM
- name: first_time_seen_remote_named_pipe
  description: This detection excludes known namped pipes accessible remotely and
    notify on newly observed ones, may help to detect lateral movement and remote
    exec using named pipes
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*IPC.*']) && ([EventID]
    == 5145) && ([ShareName] !~ ['.*.*.*.*IPC.*']) && (([RelativeTargetName] !~ ['atsvc'])
    || ([RelativeTargetName] !~ ['samr']) || ([RelativeTargetName] !~ ['lsarpc'])
    || ([RelativeTargetName] !~ ['winreg']) || ([RelativeTargetName] !~ ['netlogon'])
    || ([RelativeTargetName] !~ ['srvsvc']) || ([RelativeTargetName] !~ ['protected.*storage'])
    || ([RelativeTargetName] !~ ['wkssvc']) || ([RelativeTargetName] !~ ['browser'])
    || ([RelativeTargetName] !~ ['netdfs']) || ([RelativeTargetName] !~ ['svcctl'])
    || ([RelativeTargetName] !~ ['spoolss']) || ([RelativeTargetName] !~ ['ntsvcs'])
    || ([RelativeTargetName] !~ ['LSM.*API.*service']) || ([RelativeTargetName] !~
    ['HydraLsPipe']) || ([RelativeTargetName] !~ ['TermSrv.*API.*service']) || ([RelativeTargetName]
    !~ ['MsFteWds']))
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1077,t1021,002
  exttype: SIEM
- name: malicious_service_installations
  description: Detects known malicious service installs that only appear in cases
    of lateral movement, credential dumping, and other suspicious activities.
  condition: ([EventID] == 4697) && ([ServiceName] == ['javamtsup'])
  level: critical
  ruletype: EVALUATE
  tags: attack,persistence,privilege_escalation,t1003,t1035,t1050,car,2013-09-005,t1543,003,t1569,002
  exttype: SIEM
- name: vssaudit_security_event_source_registration
  description: Detects the registration of the security event source VSSAudit. It
    would usually trigger when volume shadow copy operations happen.
  condition: ([AuditSourceName] == ['VSSAudit']) && ([EventID] == 4904) || ([EventID]
    == 4905)
  level: medium
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,002
  exttype: SIEM
- name: hybridconnectionmanager_service_installation
  description: Rule to detect the Hybrid Connection Manager service installation.
  condition: ([EventID] == 4697) && ([ServiceName] == ['HybridConnectionManager'])
    && ([ServiceFileName] =~ ['.*HybridConnectionManager.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,persistence
  exttype: SIEM
- name: netntlm_downgrade_attack
  description: Detects NetNTLM downgrade attack
  condition: ([EventID] == 4657) && ([ObjectName] =~ ['.*.*REGISTRY.*MACHINE.*SYSTEM.*'])
    && ([ObjectName] =~ ['.*ControlSet.*']) && ([ObjectName] =~ ['.*.*Control.*Lsa.*'])
    && (([ObjectValueName] =~ ['LmCompatibilityLevel']) || ([ObjectValueName] =~ ['NtlmMinClientSec'])
    || ([ObjectValueName] =~ ['RestrictSendingNTLMTraffic']))
  level: critical
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1089,t1562,001,t1112
  exttype: SIEM
- name: suspicious_ldap_attributes_used
  description: Detects the usage of particular AttributeLDAPDisplayNames, which are
    known for data exchange via LDAP by the tool LDAPFragger and are additionally
    not commonly used in companies.
  condition: ([EventID] == 5136) && ([AttributeValue] =~ ['.*']) && (([AttributeLDAPDisplayName]
    =~ ['primaryInternationalISDNNumber']) || ([AttributeLDAPDisplayName] =~ ['otherFacsimileTelephoneNumber'])
    || ([AttributeLDAPDisplayName] =~ ['primaryTelexNumber']))
  level: high
  ruletype: EVALUATE
  tags: attack,t1071,t1001,003,command_and_control
  exttype: SIEM
- name: weak_encryption_enabled_and_kerberoast
  description: Detects scenario where weak encryption is enabled for a user profile
    which could be used for hash/password cracking.
  condition: ([EventID] == 4738) && (([NewUacValue] =~ ['.*8.*.*.*']) || ([NewUacValue]
    =~ ['.*9.*.*.*']) || ([NewUacValue] =~ ['.*A.*.*.*']) || ([NewUacValue] =~ ['.*B.*.*.*'])
    || ([NewUacValue] =~ ['.*C.*.*.*']) || ([NewUacValue] =~ ['.*D.*.*.*']) || ([NewUacValue]
    =~ ['.*E.*.*.*']) || ([NewUacValue] =~ ['.*F.*.*.*'])) && (([OldUacValue] !~ ['.*8.*.*.*'])
    || ([OldUacValue] !~ ['.*9.*.*.*']) || ([OldUacValue] !~ ['.*A.*.*.*']) || ([OldUacValue]
    !~ ['.*B.*.*.*']) || ([OldUacValue] !~ ['.*C.*.*.*']) || ([OldUacValue] !~ ['.*D.*.*.*'])
    || ([OldUacValue] !~ ['.*E.*.*.*']) || ([OldUacValue] !~ ['.*F.*.*.*'])) || (([NewUacValue]
    =~ ['.*1.*.*.*.*']) || ([NewUacValue] =~ ['.*3.*.*.*.*']) || ([NewUacValue] =~
    ['.*5.*.*.*.*']) || ([NewUacValue] =~ ['.*7.*.*.*.*']) || ([NewUacValue] =~ ['.*9.*.*.*.*'])
    || ([NewUacValue] =~ ['.*B.*.*.*.*']) || ([NewUacValue] =~ ['.*D.*.*.*.*']) ||
    ([NewUacValue] =~ ['.*F.*.*.*.*'])) && (([OldUacValue] !~ ['.*1.*.*.*.*']) ||
    ([OldUacValue] !~ ['.*3.*.*.*.*']) || ([OldUacValue] !~ ['.*5.*.*.*.*']) || ([OldUacValue]
    !~ ['.*7.*.*.*.*']) || ([OldUacValue] !~ ['.*9.*.*.*.*']) || ([OldUacValue] !~
    ['.*B.*.*.*.*']) || ([OldUacValue] !~ ['.*D.*.*.*.*']) || ([OldUacValue] !~ ['.*F.*.*.*.*']))
    || (([NewUacValue] =~ ['.*8.*.*']) || ([NewUacValue] =~ ['.*9.*.*']) || ([NewUacValue]
    =~ ['.*A.*.*']) || ([NewUacValue] =~ ['.*B.*.*']) || ([NewUacValue] =~ ['.*C.*.*'])
    || ([NewUacValue] =~ ['.*D.*.*']) || ([NewUacValue] =~ ['.*E.*.*']) || ([NewUacValue]
    =~ ['.*F.*.*'])) && (([OldUacValue] !~ ['.*8.*.*']) || ([OldUacValue] !~ ['.*9.*.*'])
    || ([OldUacValue] !~ ['.*A.*.*']) || ([OldUacValue] !~ ['.*B.*.*']) || ([OldUacValue]
    !~ ['.*C.*.*']) || ([OldUacValue] !~ ['.*D.*.*']) || ([OldUacValue] !~ ['.*E.*.*'])
    || ([OldUacValue] !~ ['.*F.*.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1089,t1562,001
  exttype: SIEM
- name: tap_driver_installation
  description: Well-known TAP software installation. Possible preparation for data
    exfiltration using tunnelling techniques
  condition: ([EventID] == 4697) && ([ImagePath] =~ ['.*tap0901.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,exfiltration,t1048
  exttype: SIEM
- name: active_directory_replication_from_non_machine_account
  description: Detects potential abuse of Active Directory Replication Service (ADRS)
    from a non machine account to request credentials.
  condition: ([EventID] == 4662) && ([AccessMask] == ['0x100']) && (([Properties]
    =~ ['.*1131f6aa.*9c07.*11d1.*f79f.*00c04fc2dcd2.*']) || ([Properties] =~ ['.*1131f6ad.*9c07.*11d1.*f79f.*00c04fc2dcd2.*'])
    || ([Properties] =~ ['.*89e95b76.*444d.*4c62.*991a.*0facbeda640c.*'])) && ([SubjectUserName]
    !~ ['.*.*']) || ([SubjectUserName] !~ ['MSOL.*.*'])
  level: critical
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,006
  exttype: SIEM
- name: syskey_registry_keys_access
  description: Detects handle requests and access operations to specific registry
    keys to calculate the SysKey
  condition: (([EventID] == 4656) || ([EventID] == 4663)) && ([ObjectType] == ['key'])
    && (([ObjectName] =~ ['.*lsa.*JD']) || ([ObjectName] =~ ['.*lsa.*GBG']) || ([ObjectName]
    =~ ['.*lsa.*Skew1']) || ([ObjectName] =~ ['.*lsa.*Data']))
  level: critical
  ruletype: EVALUATE
  tags: attack,discovery,t1012
  exttype: SIEM
- name: t1021_dcom_internetexplorer_application_iertutil_dll_hijack
  description: Detects a threat actor creating a file named `iertutil.dll` in the
    `C:\Program Files\Internet Explorer\` directory over the network for a DCOM InternetExplorer
    DLL Hijack scenario.
  condition: ([EventID] == 5145) && ([RelativeTargetName] =~ ['.*.*Internet.*Explorer.*iertutil.dll'])
    && ([SubjectUserName] !~ ['.*.*'])
  level: critical
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1021,002,003
  exttype: SIEM
- name: rottenpotato_like_attack_pattern
  description: Detects logon events that have characteristics of events generated
    during an attack with RottenPotato and the like
  condition: ([EventID] == 4624) && ([LogonType] == 3) && ([TargetUserName] == ['ANONYMOUS_LOGON'])
    && ([WorkstationName] == ['-']) && ([IpAddress] == ['127.0.0.1'])
  level: high
  ruletype: EVALUATE
  tags: attack,privilege_escalation,credential_access,t1171,t1557,001
  exttype: SIEM
- name: account_tampering___suspicious_failed_logon_reasons
  description: This method uses uncommon error codes on failed logons to determine
    suspicious activity and tampering with accounts that have been disabled or somehow
    restricted.
  condition: (([EventID] == 4625) || ([EventID] == 4776)) && (([Status] =~ ['0xC0000072'])
    || ([Status] =~ ['0xC000006F']) || ([Status] =~ ['0xC0000070']) || ([Status] =~
    ['0xC0000413']) || ([Status] =~ ['0xC000018C']) || ([Status] =~ ['0xC000015B']))
  level: high
  ruletype: EVALUATE
  tags: attack,persistence,defense_evasion,privilege_escalation,initial_access,t1078
  exttype: SIEM
- name: enabled_user_right_in_ad_to_control_user_objects
  description: Detects scenario where if a user is assigned the SeEnableDelegationPrivilege
    right in Active Directory it would allow control of other AD user objects.
  condition: ([EventID] == 4704) && (([PrivilegeList] =~ ['.*SeEnableDelegationPrivilege.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,persistence,t1098
  exttype: SIEM
- name: remote_task_creation_via_atsvc_named_pipe
  description: Detects remote task creation via at.exe or API interacting with ATSVC
    namedpipe
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*IPC.*']) && ([RelativeTargetName]
    == ['atsvc']) && ([Accesses] =~ ['.*WriteData.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,lateral_movement,persistence,t1053,car,2013-05-004,2015-04-001,002
  exttype: SIEM
- name: password_change_on_directory_service_restore_mode__dsrm__account
  description: The Directory Service Restore Mode (DSRM) account is a local administrator
    account on Domain Controllers. Attackers may change the password to gain persistence.
  condition: ([EventID] == 4794)
  level: high
  ruletype: EVALUATE
  tags: attack,persistence,t1098
  exttype: SIEM
- name: ad_object_writedac_access
  description: Detects WRITE_DAC access to a domain object
  condition: ([EventID] == 4662) && ([ObjectServer] == ['DS']) && ([AccessMask] ==
    ['0x40000']) && (([ObjectType] =~ ['19195a5b.*6da0.*11d0.*afd3.*00c04fd930c9'])
    || ([ObjectType] =~ ['domainDNS']))
  level: critical
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1222,001
  exttype: SIEM
- name: reconnaissance_activity
  description: Detects activity as "net user administrator /domain" and "net group
    domain admins /domain"
  condition: ([EventID] == 4661) && (([ObjectType] =~ ['SAM.*USER']) || ([ObjectType]
    =~ ['SAM.*GROUP'])) && ([ObjectName] =~ ['S.*1.*5.*21.*.*']) && ([AccessMask]
    == ['0x2d']) && (([ObjectName] =~ ['.*.*500']) || ([ObjectName] =~ ['.*.*512']))
  level: high
  ruletype: EVALUATE
  tags: attack,discovery,t1087,002,t1069,s0039
  exttype: SIEM
- name: impacket_psexec_execution
  description: Detects execution of Impacket's psexec.py.
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*IPC.*']) && (([RelativeTargetName]
    =~ ['.*RemCom.*stdint.*']) || ([RelativeTargetName] =~ ['.*RemCom.*stdoutt.*'])
    || ([RelativeTargetName] =~ ['.*RemCom.*stderrt.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1021,002
  exttype: SIEM
- name: powershell_scripts_installed_as_services
  description: Detects powershell script installed as a Service
  condition: ([EventID] == 4697) && (([ServiceFileName] =~ ['.*powershell.*']) ||
    ([ServiceFileName] =~ ['.*pwsh.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,execution,t1569,002
  exttype: SIEM
- name: access_to_admin__share
  description: Detects access to $ADMIN share
  condition: ([EventID] == 5140) && ([ShareName] == ['Admin$']) && ([SubjectUserName]
    !~ ['.*.*'])
  level: low
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1077,t1021,002
  exttype: SIEM
- name: iso_image_mount
  description: Detects the mount of ISO images on an endpoint
  condition: ([EventID] == 4663) && ([ObjectServer] == ['Security']) && ([ObjectType]
    == ['File']) && ([ObjectName] =~ ['.*Device.*CdRom.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,initial_access,t1566,001
  exttype: SIEM
- name: suspicious_psexec_execution
  description: detects execution of psexec or paexec with renamed service name, this
    rule helps to filter out the noise if psexec is used for legit purposes or if
    attacker uses a different psexec client other than sysinternal one
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*IPC.*']) && (([RelativeTargetName]
    =~ ['.*.*stdin']) || ([RelativeTargetName] =~ ['.*.*stdout']) || ([RelativeTargetName]
    =~ ['.*.*stderr'])) && ([EventID] == 5145) && ([ShareName] !~ ['.*.*.*.*IPC.*'])
    && ([RelativeTargetName] !~ ['PSEXESVC.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1077,t1021,002
  exttype: SIEM
- name: lsass_access_from_non_system_account
  description: Detects potential mimikatz-like tools accessing LSASS from non system
    account
  condition: (([EventID] == 4663) || ([EventID] == 4656)) && (([AccessMask] =~ ['0x40'])
    || ([AccessMask] =~ ['0x1400']) || ([AccessMask] =~ ['0x1000']) || ([AccessMask]
    =~ ['0x100000']) || ([AccessMask] =~ ['0x1410']) || ([AccessMask] =~ ['0x1010'])
    || ([AccessMask] =~ ['0x1438']) || ([AccessMask] =~ ['0x143a']) || ([AccessMask]
    =~ ['0x1418']) || ([AccessMask] =~ ['0x1f0fff']) || ([AccessMask] =~ ['0x1f1fff'])
    || ([AccessMask] =~ ['0x1f2fff']) || ([AccessMask] =~ ['0x1f3fff']) || ([AccessMask]
    =~ ['40']) || ([AccessMask] =~ ['1400']) || ([AccessMask] =~ ['1000']) || ([AccessMask]
    =~ ['100000']) || ([AccessMask] =~ ['1410']) || ([AccessMask] =~ ['1010']) ||
    ([AccessMask] =~ ['1438']) || ([AccessMask] =~ ['143a']) || ([AccessMask] =~ ['1418'])
    || ([AccessMask] =~ ['1f0fff']) || ([AccessMask] =~ ['1f1fff']) || ([AccessMask]
    =~ ['1f2fff']) || ([AccessMask] =~ ['1f3fff'])) && ([ObjectType] == ['Process'])
    && ([ObjectName] =~ ['.*.*lsass.exe']) && ([SubjectUserName] !~ ['.*.*']) && ([ProcessName]
    !~ ['C.*.*Program.*Files.*'])
  level: critical
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,001
  exttype: SIEM
- name: dpapi_domain_master_key_backup_attempt
  description: Detects anyone attempting a backup for the DPAPI Master Key. This events
    gets generated at the source and not the Domain Controller.
  condition: ([EventID] == 4692)
  level: critical
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,004
  exttype: SIEM
- name: scanner_poc_for_cve_2019_0708_rdp_rce_vuln
  description: Detects the use of a scanner by zerosum0x0 that discovers targets vulnerable
    to  CVE-2019-0708 RDP RCE aka BlueKeep
  condition: ([EventID] == 4625) && ([AccountName] == ['AAAAAAA'])
  level: critical
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1210,car,2013-07-002
  exttype: SIEM
- name: denied_access_to_remote_desktop
  description: This event is generated when an authenticated user who is not allowed
    to log on remotely attempts to connect to this computer through Remote Desktop.
    Often, this event can be generated by attackers when searching for available windows
    servers in the network.
  condition: ([EventID] == 4825)
  level: medium
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1076,t1021,001
  exttype: SIEM
- name: secure_deletion_with_sdelete
  description: Detects renaming of file while deletion with SDelete tool.
  condition: (([EventID] == 4656) || ([EventID] == 4663) || ([EventID] == 4658)) &&
    (([ObjectName] =~ ['.*.AAA']) || ([ObjectName] =~ ['.*.ZZZ']))
  level: medium
  ruletype: EVALUATE
  tags: attack,impact,defense_evasion,t1107,t1070,004,t1066,t1027,005,t1485,t1553,002,s0195
  exttype: SIEM
- name: unauthorized_system_time_modification
  description: Detect scenarios where a potentially unauthorized application or user
    is modifying the system time.
  condition: ([EventID] == 4616) && ([ProcessName] == ['C:\Program Files\VMware\VMware
    Tools\vmtoolsd.exe']) || ([ProcessName] == ['C:\Windows\System32\VBoxService.exe'])
    || ([ProcessName] == ['C:\Windows\System32\svchost.exe']) && ([SubjectUserSid]
    == ['S-1-5-19'])
  level: medium
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1099,t1070,006
  exttype: SIEM
- name: register_new_logon_process_by_rubeus
  description: Detects potential use of Rubeus via registered new trusted logon process
  condition: ([EventID] == 4611) && ([LogonProcessName] == ['User32LogonProcesss'])
  level: critical
  ruletype: EVALUATE
  tags: attack,lateral_movement,privilege_escalation,t1208,t1558,003
  exttype: SIEM
- name: failed_code_integrity_checks
  description: Code integrity failures may indicate tampered executables.
  condition: (([EventID] == 5038) || ([EventID] == 6281))
  level: low
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1009,t1027,001
  exttype: SIEM
- name: powerview_add_domainobjectacl_dcsync_ad_extend_right
  description: backdooring domain object to grant the rights associated with DCSync
    to a regular user or machine account using Powerview\Add-DomainObjectAcl DCSync
    Extended Right cmdlet, will allow to re-obtain the pwd hashes of any user/computer
  condition: ([EventID] == 5136) && ([AttributeLDAPDisplayName] == ['ntSecurityDescriptor'])
    && (([AttributeValue] =~ ['.*1131f6ad.*9c07.*11d1.*f79f.*00c04fc2dcd2.*']) ||
    ([AttributeValue] =~ ['.*1131f6aa.*9c07.*11d1.*f79f.*00c04fc2dcd2.*']) || ([AttributeValue]
    =~ ['.*89e95b76.*444d.*4c62.*991a.*0facbeda640c.*']))
  level: critical
  ruletype: EVALUATE
  tags: attack,persistence,t1098
  exttype: SIEM
- name: dcerpc_smb_spoolss_named_pipe
  description: Detects the use of the spoolss named pipe over SMB. This can be used
    to trigger the authentication via NTLM of any machine that has the spoolservice
    enabled.
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*IPC.*']) && ([RelativeTargetName]
    == ['spoolss'])
  level: medium
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1021,002
  exttype: SIEM
- name: t1047_wmiprvse_wbemcomn_dll_hijack
  description: Detects a threat actor creating a file named `wbemcomn.dll` in the
    `C:\Windows\System32\wbem\` directory over the network for a WMI DLL Hijack scenario.
  condition: ([EventID] == 5145) && ([RelativeTargetName] =~ ['.*.*wbem.*wbemcomn.dll'])
    && ([SubjectUserName] !~ ['.*.*'])
  level: critical
  ruletype: EVALUATE
  tags: attack,execution,t1047,lateral_movement,t1021,002
  exttype: SIEM
- name: suspicious_remote_logon_with_explicit_credentials
  description: Detects suspicious processes logging on with explicit credentials
  condition: ([EventID] == 4648) && (([Image] =~ ['.*.*cmd.exe']) || ([Image] =~ ['.*.*powershell.exe'])
    || ([Image] =~ ['.*.*pwsh.exe']) || ([Image] =~ ['.*.*winrs.exe']) || ([Image]
    =~ ['.*.*wmic.exe']) || ([Image] =~ ['.*.*net.exe']) || ([Image] =~ ['.*.*net1.exe'])
    || ([Image] =~ ['.*.*reg.exe'])) && ([TargetServerName] == ['localhost'])
  level: medium
  ruletype: EVALUATE
  tags: attack,t1078,lateral_movement
  exttype: SIEM
- name: pass_the_hash_activity_2
  description: Detects the attack technique pass the hash which is used to move laterally
    inside the network
  condition: ([EventID] == 4624) && ([SubjectUserSid] == ['S-1-0-0']) && ([LogonType]
    == ['3']) && ([LogonProcessName] == ['NtLmSsp']) && ([KeyLength] == ['0']) ||
    ([LogonType] == ['9']) && ([LogonProcessName] == ['seclogo']) && ([AccountName]
    == ['ANONYMOUS LOGON'])
  level: medium
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1075,t1550,002
  exttype: SIEM
- name: ad_user_enumeration
  description: Detects access to a domain user from a non-machine account
  condition: ([EventID] == 4662) && ([ObjectType] =~ ['.*bf967aba.*0de6.*11d0.*a285.*00aa003049e2.*'])
    && ([SubjectUserName] !~ ['.*.*']) || ([SubjectUserName] !~ ['MSOL.*.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,discovery,t1087,002
  exttype: SIEM
- name: possible_dc_shadow
  description: Detects DCShadow via create new SPN
  condition: ([EventID] == 4742) && ([ServicePrincipalNames] =~ ['.*GC.*.*']) || ([EventID]
    == 5136) && ([AttributeLDAPDisplayName] == ['servicePrincipalName']) && ([AttributeValue]
    =~ ['GC.*.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,credential_access,t1207
  exttype: SIEM
- name: admin_user_remote_logon
  description: Detect remote login by Administrator user (depending on internal pattern).
  condition: ([EventID] == 4624) && ([LogonType] == 10) && ([AuthenticationPackageName]
    == ['Negotiate']) && ([TargetUserName] =~ ['Admin.*'])
  level: low
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1078,001,002,003,car,2016-04-005
  exttype: SIEM
- name: rdp_login_from_localhost
  description: RDP login with localhost source address may be a tunnelled login
  condition: ([EventID] == 4624) && ([LogonType] == 10) && (([IpAddress] =~ ['.*.*1'])
    || ([IpAddress] =~ ['127.0.0.1']))
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1076,car,2013-07-002,t1021,001
  exttype: SIEM
- name: interactive_logon_to_server_systems
  description: Detects interactive console logons to Server Systems
  condition: (([EventID] == 528) || ([EventID] == 529) || ([EventID] == 4624) || ([EventID]
    == 4625)) && ([LogonType] == 2) && (([ComputerName] =~ ['.*ServerSystems.*'])
    || ([ComputerName] =~ ['.*DomainControllers.*'])) && ([LogonProcessName] == ['Advapi'])
    && ([ComputerName] == ['%Workstations%'])
  level: medium
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1078
  exttype: SIEM
- name: suspicious_kerberos_rc4_ticket_encryption
  description: Detects service ticket requests using RC4 encryption type
  condition: ([EventID] == 4769) && ([TicketOptions] == ['0x40810000']) && ([TicketEncryptionType]
    == ['0x17']) && ([ServiceName] !~ ['.*.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,credential_access,t1208,t1558,003
  exttype: SIEM
- name: suspicious_access_to_sensitive_file_extensions
  description: Detects known sensitive file extensions accessed on a network share
  condition: ([EventID] == 5145) && (([RelativeTargetName] =~ ['.*.pst']) || ([RelativeTargetName]
    =~ ['.*.ost']) || ([RelativeTargetName] =~ ['.*.msg']) || ([RelativeTargetName]
    =~ ['.*.nst']) || ([RelativeTargetName] =~ ['.*.oab']) || ([RelativeTargetName]
    =~ ['.*.edb']) || ([RelativeTargetName] =~ ['.*.nsf']) || ([RelativeTargetName]
    =~ ['.*.bak']) || ([RelativeTargetName] =~ ['.*.dmp']) || ([RelativeTargetName]
    =~ ['.*.kirbi']) || ([RelativeTargetName] =~ ['.*.*groups.xml']) || ([RelativeTargetName]
    =~ ['.*.rdp']))
  level: medium
  ruletype: EVALUATE
  tags: attack,collection,t1039
  exttype: SIEM
- name: password_dumper_activity_on_lsass
  description: Detects process handle on LSASS process with certain access mask and
    object type SAM_DOMAIN
  condition: ([EventID] == 4656) && ([ProcessName] =~ ['.*.*lsass.exe']) && ([AccessMask]
    == ['0x705']) && ([ObjectType] == ['SAM_DOMAIN'])
  level: high
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,001
  exttype: SIEM
- name: user_added_to_local_administrators
  description: This rule triggers on user accounts that are added to the local Administrators
    group, which could be legitimate activity or a sign of privilege escalation activity
  condition: ([EventID] == 4732) && ([TargetUserName] =~ ['Administr.*']) || ([TargetSid]
    == ['S-1-5-32-544']) && ([SubjectUserName] !~ ['.*.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,privilege_escalation,t1078,persistence,t1098
  exttype: SIEM
- name: dpapi_domain_backup_key_extraction
  description: Detects tools extracting LSA secret DPAPI domain backup key from Domain
    Controllers
  condition: ([EventID] == 4662) && ([ObjectType] == ['SecretObject']) && ([AccessMask]
    == ['0x2']) && ([ObjectName] == ['BCKUPKEY'])
  level: critical
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,004
  exttype: SIEM
- name: failed_logon_from_public_ip
  description: A login from a public IP can indicate a misconfigured firewall or network
    boundary.
  condition: ([EventID] == 4625) && ([IpAddress] !~ ['.*.*.*']) || (([IpAddress] !~
    ['10..*']) || ([IpAddress] !~ ['192.168..*']) || ([IpAddress] !~ ['172.16..*'])
    || ([IpAddress] !~ ['172.17..*']) || ([IpAddress] !~ ['172.18..*']) || ([IpAddress]
    !~ ['172.19..*']) || ([IpAddress] !~ ['172.20..*']) || ([IpAddress] !~ ['172.21..*'])
    || ([IpAddress] !~ ['172.22..*']) || ([IpAddress] !~ ['172.23..*']) || ([IpAddress]
    !~ ['172.24..*']) || ([IpAddress] !~ ['172.25..*']) || ([IpAddress] !~ ['172.26..*'])
    || ([IpAddress] !~ ['172.27..*']) || ([IpAddress] !~ ['172.28..*']) || ([IpAddress]
    !~ ['172.29..*']) || ([IpAddress] !~ ['172.30..*']) || ([IpAddress] !~ ['172.31..*'])
    || ([IpAddress] !~ ['127..*']) || ([IpAddress] !~ ['169.254..*'])) || ([IpAddress]
    == ['::1']) || (([IpAddress] !~ ['fe80.*.*.*']) || ([IpAddress] !~ ['fc00.*.*.*']))
  level: medium
  ruletype: EVALUATE
  tags: attack,initial_access,persistence,t1078,t1190,t1133
  exttype: SIEM
- name: suspicious_driver_loaded_by_user
  description: Detects the loading of drivers via 'SeLoadDriverPrivilege' required
    to load or unload a device driver. With this privilege, the user can dynamically
    load and unload device drivers or other code in to kernel mode. This user right
    does not apply to Plug and Play device drivers. If you exclude privileged users/admins
    and processes, which are allowed to do so, you are maybe left with bad programs
    trying to load malicious kernel drivers. This will detect Ghost-In-The-Logs (https://github.com/bats3c/Ghost-In-The-Logs)
    and the usage of Sysinternals and various other tools. So you have to work with
    a whitelist to find the bad stuff.
  condition: ([EventID] == 4673) && ([PrivilegeList] == ['SeLoadDriverPrivilege'])
    && ([Service] == ['-']) && (([ProcessName] !~ ['.*.*Windows.*System32.*Dism.exe'])
    || ([ProcessName] !~ ['.*.*Windows.*System32.*rundll32.exe']) || ([ProcessName]
    !~ ['.*.*Windows.*System32.*fltMC.exe']) || ([ProcessName] !~ ['.*.*Windows.*HelpPane.exe'])
    || ([ProcessName] !~ ['.*.*Windows.*System32.*mmc.exe']) || ([ProcessName] !~
    ['.*.*Windows.*System32.*svchost.exe']) || ([ProcessName] !~ ['.*.*Windows.*System32.*wimserv.exe'])
    || ([ProcessName] !~ ['.*.*procexp64.exe']) || ([ProcessName] !~ ['.*.*procexp.exe'])
    || ([ProcessName] !~ ['.*.*procmon64.exe']) || ([ProcessName] !~ ['.*.*procmon.exe'])
    || ([ProcessName] !~ ['.*.*Google.*Chrome.*Application.*chrome.exe']))
  level: medium
  ruletype: EVALUATE
  tags: attack,t1089,defense_evasion,t1562,001
  exttype: SIEM
- name: user_couldn_t_call_a_privileged_service__lsaregisterlogonprocess_
  description: The 'LsaRegisterLogonProcess' function verifies that the application
    making the function call is a logon process by checking that it has the SeTcbPrivilege
    privilege set. Possible Rubeus tries to get a handle to LSA.
  condition: ([EventID] == 4673) && ([Service] == ['LsaRegisterLogonProcess()']) &&
    ([Keywords] == ['0x8010000000000000'])
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,privilege_escalation,t1208,t1558,003
  exttype: SIEM
- name: possible_impacket_secretdump_remote_activity
  description: Detect AD credential dumping using impacket secretdump HKTL
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*ADMIN.*']) && ([RelativeTargetName]
    =~ ['.*SYSTEM32.*.*.*']) && ([RelativeTargetName] =~ ['.*.tmp.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,002,004,003
  exttype: SIEM
- name: transferring_files_with_credential_data_via_network_shares
  description: Transferring files with well-known filenames (sensitive files with
    credential data) using network shares
  condition: ([EventID] == 5145) && (([RelativeTargetName] =~ ['.*.*mimidrv.*']) ||
    ([RelativeTargetName] =~ ['.*.*lsass.*']) || ([RelativeTargetName] =~ ['.*.*windows.*minidump.*.*.*'])
    || ([RelativeTargetName] =~ ['.*.*hiberfil.*']) || ([RelativeTargetName] =~ ['.*.*sqldmpr.*'])
    || ([RelativeTargetName] =~ ['.*.*sam.*']) || ([RelativeTargetName] =~ ['.*.*ntds.dit.*'])
    || ([RelativeTargetName] =~ ['.*.*security.*']))
  level: medium
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,002,001,003
  exttype: SIEM
- name: complus_etwenabled_registry_modification
  description: Potential adversaries stopping ETW providers recording loaded .NET
    assemblies.
  condition: ([EventID] == 4657) && ([ObjectName] =~ ['.*.*SOFTWARE.*Microsoft.*.NETFramework'])
    && ([ObjectValueName] == ['ETWEnabled']) && ([NewValue] == ['0'])
  level: critical
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1112
  exttype: SIEM
- name: processes_accessing_the_microphone_and_webcam
  description: Potential adversaries accessing the microphone and webcam in an endpoint.
  condition: (([EventID] == 4657) || ([EventID] == 4656) || ([EventID] == 4663)) &&
    ([ObjectName] =~ ['.*.*SOFTWARE.*Microsoft.*Windows.*CurrentVersion.*CapabilityAccessManager.*ConsentStore.*microphone.*NonPackaged.*'])
    || ([ObjectName] =~ ['.*.*SOFTWARE.*Microsoft.*Windows.*CurrentVersion.*CapabilityAccessManager.*ConsentStore.*webcam.*NonPackaged.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,collection,t1123
  exttype: SIEM
- name: addition_of_sid_history_to_active_directory_object
  description: An attacker can use the SID history attribute to gain additional privileges.
  condition: (([EventID] == 4765) || ([EventID] == 4766)) || ([EventID] == 4738) &&
    (([SidHistory] !~ ['.*']) || ([SidHistory] !~ ['.*.*1793']))
  level: medium
  ruletype: EVALUATE
  tags: attack,persistence,privilege_escalation,t1178,t1134,005
  exttype: SIEM
- name: remote_registry_management_using_reg_utility
  description: Remote registry management using REG utility from non-admin workstation
  condition: ([EventID] == 5145) && ([RelativeTargetName] =~ ['.*.*winreg.*']) &&
    ([IpAddress] == ['%Admins_Workstations%'])
  level: medium
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1112,discovery,t1012,credential_access,t1552,002,s0075
  exttype: SIEM
- name: suspicious_outbound_kerberos_connection
  description: Detects suspicious outbound network activity via kerberos default port
    indicating possible lateral movement or first stage PrivEsc via delegation.
  condition: ([EventID] == 5156) && ([DestinationPort] == 88) && (([Image] !~ ['.*.*lsass.exe'])
    || ([Image] !~ ['.*.*opera.exe']) || ([Image] !~ ['.*.*chrome.exe']) || ([Image]
    !~ ['.*.*firefox.exe']))
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1208,t1558,003
  exttype: SIEM
- name: wce_wceaux_dll_access
  description: Detects wceaux.dll access while WCE pass-the-hash remote command execution
    on source host
  condition: (([EventID] == 4656) || ([EventID] == 4658) || ([EventID] == 4660) ||
    ([EventID] == 4663)) && ([ObjectName] =~ ['.*.*wceaux.dll'])
  level: critical
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,s0005
  exttype: SIEM
- name: scheduled_task_deletion
  description: Detects scheduled task deletion events. Scheduled tasks are likely
    to be deleted if not used for persistence. Malicious Software often creates tasks
    directly under the root node e.g. \TASKNAME
  condition: ([EventID] == 4699)
  level: medium
  ruletype: EVALUATE
  tags: attack,execution,privilege_escalation,t1053,car,2013-08-001,005
  exttype: SIEM
- name: login_with_wmi
  description: Detection of logins performed with WMI
  condition: ([EventID] == 4624) && ([ProcessName] =~ ['.*.*WmiPrvSE.exe'])
  level: low
  ruletype: EVALUATE
  tags: attack,execution,t1047
  exttype: SIEM
- name: addition_of_domain_trusts
  description: Addition of domains is seldom and should be verified for legitimacy.
  condition: ([EventID] == 4706)
  level: medium
  ruletype: EVALUATE
  tags: attack,persistence
  exttype: SIEM
- name: successful_overpass_the_hash_attempt
  description: Detects successful logon with logon type 9 (NewCredentials) which matches
    the Overpass the Hash behavior of e.g Mimikatz's sekurlsa::pth module.
  condition: ([EventID] == 4624) && ([LogonType] == 9) && ([LogonProcessName] == ['seclogo'])
    && ([AuthenticationPackageName] == ['Negotiate'])
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1075,s0002,t1550,002
  exttype: SIEM
- name: scm_database_handle_failure
  description: Detects non-system users failing to get a handle of the SCM database.
  condition: ([EventID] == 4656) && ([ObjectType] == ['SC_MANAGER OBJECT']) && ([ObjectName]
    == ['servicesactive']) && ([Keywords] == ['Audit Failure']) && ([SubjectLogonId]
    == ['0x3e4'])
  level: critical
  ruletype: EVALUATE
  tags: attack,discovery
  exttype: SIEM
- name: credential_dumping_tools_service_execution
  description: Detects well-known credential dumping tools execution via service execution
    events
  condition: (([ServiceName] =~ ['.*fgexec.*']) || ([ServiceName] =~ ['.*wceservice.*'])
    || ([ServiceName] =~ ['.*wce.*service.*']) || ([ServiceName] =~ ['.*pwdump.*'])
    || ([ServiceName] =~ ['.*gsecdump.*']) || ([ServiceName] =~ ['.*cachedump.*'])
    || ([ServiceName] =~ ['.*mimikatz.*']) || ([ServiceName] =~ ['.*mimidrv.*']))
    || (([ImagePath] =~ ['.*fgexec.*']) || ([ImagePath] =~ ['.*dumpsvc.*']) || ([ImagePath]
    =~ ['.*cachedump.*']) || ([ImagePath] =~ ['.*mimidrv.*']) || ([ImagePath] =~ ['.*gsecdump.*'])
    || ([ImagePath] =~ ['.*servpw.*']) || ([ImagePath] =~ ['.*pwdump.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,credential_access,execution,t1003,001,002,004,005,006,t1035,t1569,s0005
  exttype: SIEM
- name: mimikatz_dc_sync
  description: Detects Mimikatz DC sync security events
  condition: ([EventID] == 4662) && (([Properties] =~ ['.*Replicating.*Directory.*Changes.*All.*'])
    || ([Properties] =~ ['.*1131f6ad.*9c07.*11d1.*f79f.*00c04fc2dcd2.*'])) && ([SubjectDomainName]
    == ['Window Manager']) && (([SubjectUserName] !~ ['NT.*AUTHORITY.*']) || ([SubjectUserName]
    !~ ['MSOL.*.*'])) && ([SubjectUserName] !~ ['.*.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,credential_access,s0002,t1003,006
  exttype: SIEM
- name: protected_storage_service_access
  description: Detects access to a protected_storage service over the network. Potential
    abuse of DPAPI to extract domain backup keys from Domain Controllers
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*IPC.*']) && ([RelativeTargetName]
    == ['protected_storage'])
  level: critical
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1021,002
  exttype: SIEM
- name: remote_powershell_sessions_network_connections__winrm_
  description: Detects basic PowerShell Remoting (WinRM) by monitoring for network
    inbound connections to ports 5985 OR 5986
  condition: ([EventID] == 5156) && (([DestPort] == 5985) || ([DestPort] == 5986))
    && ([LayerRTID] == 44)
  level: high
  ruletype: EVALUATE
  tags: attack,execution,t1086,t1059,001
  exttype: SIEM
- name: new_or_renamed_user_account_with_____in_attribute__samaccountname__
  description: Detects possible bypass EDR and SIEM via abnormal user account name.
  condition: (([EventID] == 4720) || ([EventID] == 4781)) && ([SamAccountName] =~
    ['.*.*.*'])
  level: high
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1036
  exttype: SIEM
- name: sam_registry_hive_handle_request
  description: Detects handles requested to SAM registry hive
  condition: ([EventID] == 4656) && ([ObjectType] == ['Key']) && ([ObjectName] =~
    ['.*.*SAM'])
  level: critical
  ruletype: EVALUATE
  tags: attack,discovery,t1012,credential_access,t1552,002
  exttype: SIEM
- name: cve_2021_1675_print_spooler_exploitation_ipc_access
  description: Detects remote printer driver load from Detailed File Share in Security
    logs that are a sign of successful exploitation attempts against print spooler
    vulnerability CVE-2021-1675 and CVE-2021-34527
  condition: ([EventID] == ['5145']) && ([ShareName] =~ ['.*.*.*.*.*IPC.*']) && ([RelativeTargetName]
    == ['spoolss']) && ([AccessMask] == ['0x3']) && ([ObjectType] == ['File'])
  level: critical
  ruletype: EVALUATE
  tags: attack,execution
  exttype: SIEM
- name: persistence_and_execution_at_scale_via_gpo_scheduled_task
  description: Detect lateral movement using GPO scheduled task, usually used to deploy
    ransomware at scale
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*SYSVOL']) && ([RelativeTargetName]
    =~ ['.*ScheduledTasks.xml']) && (([Accesses] =~ ['.*WriteData.*']) || ([Accesses]
    =~ ['.*.*.*4417.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,persistence,lateral_movement,t1053,005
  exttype: SIEM
- name: hacktool_ruler
  description: This events that are generated when using the hacktool Ruler by Sensepost
  condition: ([EventID] == 4776) && ([Workstation] == ['RULER']) || (([EventID] ==
    4624) || ([EventID] == 4625)) && ([WorkstationName] == ['RULER'])
  level: high
  ruletype: EVALUATE
  tags: attack,discovery,execution,t1087,t1075,t1114,t1059,t1550,002
  exttype: SIEM
- name: eventlog_cleared
  description: One of the Windows Eventlogs has been cleared. e.g. caused by "wevtutil
    cl" command execution
  condition: (([EventID] == 517) || ([EventID] == 1102))
  level: high
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1070,001,car,2016-04-002
  exttype: SIEM
- name: security_event_log_cleared
  description: Checks for event id 1102 which indicates the security event log was
    cleared.
  condition: ([EventID] == 1102)
  level: medium
  ruletype: EVALUATE
  tags: attack,t1107,t1070,001
  exttype: SIEM
- name: generic_password_dumper_activity_on_lsass
  description: Detects process handle on LSASS process with certain access mask
  condition: ([EventID] == 4656) && ([ObjectName] =~ ['.*.*lsass.exe']) && (([AccessMask]
    =~ ['.*0x40.*']) || ([AccessMask] =~ ['.*0x1400.*']) || ([AccessMask] =~ ['.*0x1000.*'])
    || ([AccessMask] =~ ['.*0x100000.*']) || ([AccessMask] =~ ['.*0x1410.*']) || ([AccessMask]
    =~ ['.*0x1010.*']) || ([AccessMask] =~ ['.*0x1438.*']) || ([AccessMask] =~ ['.*0x143a.*'])
    || ([AccessMask] =~ ['.*0x1418.*']) || ([AccessMask] =~ ['.*0x1f0fff.*']) || ([AccessMask]
    =~ ['.*0x1f1fff.*']) || ([AccessMask] =~ ['.*0x1f2fff.*']) || ([AccessMask] =~
    ['.*0x1f3fff.*'])) || ([EventID] == 4663) && ([ObjectName] =~ ['.*.*lsass.exe'])
    && (([AccessList] =~ ['.*4484.*']) || ([AccessList] =~ ['.*4416.*'])) && (([ProcessName]
    !~ ['.*.*wmiprvse.exe']) || ([ProcessName] !~ ['.*.*taskmgr.exe']) || ([ProcessName]
    !~ ['.*.*procexp64.exe']) || ([ProcessName] !~ ['.*.*procexp.exe']) || ([ProcessName]
    !~ ['.*.*lsm.exe']) || ([ProcessName] !~ ['.*.*csrss.exe']) || ([ProcessName]
    !~ ['.*.*wininit.exe']) || ([ProcessName] !~ ['.*.*vmtoolsd.exe']) || ([ProcessName]
    !~ ['.*.*minionhost.exe']) || ([ProcessName] !~ ['.*.*VsTskMgr.exe']) || ([ProcessName]
    !~ ['.*.*thor64.exe'])) && (([ProcessName] !~ ['C.*.*Windows.*System32.*.*.*'])
    || ([ProcessName] !~ ['C.*.*Windows.*SysWow64.*.*.*']) || ([ProcessName] !~ ['C.*.*Windows.*SysNative.*.*.*'])
    || ([ProcessName] !~ ['C.*.*Program.*Files.*.*.*']) || ([ProcessName] !~ ['C.*.*Windows.*Temp.*asgard2.*agent.*.*.*']))
    && (([ProcessName] !~ ['C.*.*Program.*Files.*']))
  level: high
  ruletype: EVALUATE
  tags: attack,credential_access,t1003,car,2019-04-004,001
  exttype: SIEM
- name: sysmon_channel_reference_deletion
  description: Potential threat actor tampering with Sysmon manifest and eventually
    disabling it
  condition: (([ObjectName] =~ ['.*WINEVT.*Publishers.*.*5770385f.*c22a.*43e0.*bf4c.*06f5698ffbd9.*.*'])
    || ([ObjectName] =~ ['.*WINEVT.*Channels.*Microsoft.*Windows.*Sysmon.*Operational.*']))
    && ([EventID] == 4657) && ([ObjectValueName] == ['Enabled']) && ([NewValue] ==
    ['0']) || ([EventID] == 4663) && ([AccessMask] == 65536)
  level: critical
  ruletype: EVALUATE
  tags: attack,defense_evasion,t1112
  exttype: SIEM
- name: remote_service_activity_via_svcctl_named_pipe
  description: Detects remote service activity via remote access to the svcctl named
    pipe
  condition: ([EventID] == 5145) && ([ShareName] =~ ['.*.*.*.*IPC.*']) && ([RelativeTargetName]
    == ['svcctl']) && ([Accesses] =~ ['.*WriteData.*'])
  level: medium
  ruletype: EVALUATE
  tags: attack,lateral_movement,persistence,t1077,t1021,002
  exttype: SIEM
- name: remote_wmi_activescripteventconsumers
  description: Detect potential adversaries leveraging WMI ActiveScriptEventConsumers
    remotely to move laterally in a network
  condition: ([EventID] == 4624) && ([LogonType] == 3) && ([ProcessName] =~ ['.*scrcons.exe'])
    && ([TargetLogonId] == ['0x3e7'])
  level: high
  ruletype: EVALUATE
  tags: attack,lateral_movement,privilege_escalation,persistence,t1546,003
  exttype: SIEM
- name: external_disk_drive_or_usb_storage_device
  description: Detects external diskdrives or plugged in USB devices , EventID 6416
    on windows 10 or later
  condition: ([EventID] == 6416) && ([ClassName] == ['DiskDrive']) || ([DeviceDescription]
    == ['USB Mass Storage Device'])
  level: low
  ruletype: EVALUATE
  tags: attack,t1091,t1200,lateral_movement,initial_access
  exttype: SIEM
- name: scm_database_privileged_operation
  description: Detects non-system users performing privileged operation os the SCM
    database
  condition: ([EventID] == 4674) && ([ObjectType] == ['SC_MANAGER OBJECT']) && ([ObjectName]
    == ['servicesactive']) && ([PrivilegeList] == ['SeTakeOwnershipPrivilege']) &&
    ([SubjectLogonId] == ['0x3e4'])
  level: critical
  ruletype: EVALUATE
  tags: ""
  exttype: SIEM
- name: local_user_creation
  description: Detects local user creation on windows servers, which shouldn't happen
    in an Active Directory environment. Apply this Sigma Use Case on your windows
    server logs and not on your DC logs.
  condition: ([EventID] == 4720)
  level: low
  ruletype: EVALUATE
  tags: attack,persistence,t1136,001
  exttype: SIEM
- name: pass_the_hash_activity
  description: Detects the attack technique pass the hash which is used to move laterally
    inside the network
  condition: ([LogonType] == ['3']) && ([LogonProcessName] == ['NtLmSsp']) && ([WorkstationName]
    == ['%Workstations%']) && ([ComputerName] == ['%Workstations%']) && ([EventID]
    == 4624) || ([EventID] == 4625) && ([AccountName] == ['ANONYMOUS LOGON'])
  level: medium
  ruletype: EVALUATE
  tags: attack,lateral_movement,t1075,car,2016-04-004,t1550,002
  exttype: SIEM
- name: operation_wocao_activity
  description: Detects activity mentioned in Operation Wocao report
  condition: ([EventID] == 4799) && ([TargetUserName] =~ ['Administr.*']) && ([CallerProcessName]
    =~ ['.*.*checkadmin.exe'])
  level: high
  ruletype: EVALUATE
  tags: attack,discovery,t1012,defense_evasion,t1036,004,t1027,execution,t1053,005,t1059,001,t1086
  exttype: SIEM
- name: chafer_activity
  description: Detects Chafer activity attributed to OilRig as reported in Nyotron
    report in March 2018
  condition: ([EventID] == 4698) && (([TaskName] =~ ['SC.*Scheduled.*Scan']) || ([TaskName]
    =~ ['UpdatMachine']))
  level: critical
  ruletype: EVALUATE
  tags: attack,persistence,g0049,t1053,005,s0111,t1050,t1543,003,defense_evasion,t1112,command_and_control,t1071,004
  exttype: SIEM
- name: defrag_deactivation
  description: Detects the deactivation and disabling of the Scheduled defragmentation
    task as seen by Slingshot APT group
  condition: ([EventID] == 4701) && ([TaskName] == ['\Microsoft\Windows\Defrag\ScheduledDefrag'])
  level: medium
  ruletype: EVALUATE
  tags: attack,persistence,s0111
  exttype: SIEM
- name: group_modification_logging
  description: Configure systems to issue a log entry and alert when an account is
    added to or removed from any group assigned administrative privileges. Sigma detects
    Event ID 4728 indicates a Member is added to a Security Group. Event ID 4729
    indicates a Member is removed from a Security enabled-group. Event ID 4730 indicates
    aSecurity Group is deleted. The case is not applicable for Unix OS. Supported
    OS - Windows 2008 R2 and 7, Windows 2012 R2 and 8.1, Windows 2016 and 10 Windows
    Server 2019, Windows Server 2000, Windows 2003 and XP.
  condition: (([EventID] == 4728) || ([EventID] == 4729) || ([EventID] == 4730) ||
    ([EventID] == 633) || ([EventID] == 632) || ([EventID] == 634))
  level: low
  ruletype: EVALUATE
  tags: ""
  exttype: SIEM
- name: locked_workstation
  description: Automatically lock workstation sessions after a standard period of
    inactivity. The case is not applicable for Unix OS. Supported OS - Windows 2008
    R2 and 7, Windows 2012 R2 and 8.1, Windows 2016 and 10 Windows Server 2019.
  condition: (([EventID] == 4800))
  level: low
  ruletype: EVALUATE
  tags: ""
  exttype: SIEM
